#!/bin/sh
# Installer script for {{PROJECT_NAME}}
# Usage: curl -fsSL https://install.keathmilligan.dev/{{PROJECT_NAME}}/install.sh | sh
#        curl -fsSL ... | sh -s -- --version 1.2.3
set -eu

PROJECT="{{PROJECT_NAME}}"
BINARY="{{BINARY_NAME}}"
REPO="{{GITHUB_REPO}}"
INSTALL_DIR="${INSTALL_DIR:-$HOME/.local/bin}"
VERSION=""

# Parse arguments
while [ $# -gt 0 ]; do
  case "$1" in
    --version) VERSION="$2"; shift 2 ;;
    --install-dir) INSTALL_DIR="$2"; shift 2 ;;
    *) echo "Unknown option: $1"; exit 1 ;;
  esac
done

# Detect OS
OS="$(uname -s)"
case "$OS" in
  Linux)  OS_TAG="unknown-linux-gnu" ;;
  Darwin) OS_TAG="apple-darwin" ;;
  *) echo "Error: Unsupported OS: $OS"; echo "Supported: Linux, macOS"; exit 1 ;;
esac

# Detect architecture
ARCH="$(uname -m)"
case "$ARCH" in
  x86_64|amd64)  ARCH_TAG="x86_64" ;;
  aarch64|arm64) ARCH_TAG="aarch64" ;;
  *) echo "Error: Unsupported architecture: $ARCH"; echo "Supported: x86_64, aarch64"; exit 1 ;;
esac

TARGET="${ARCH_TAG}-${OS_TAG}"

# Check for musl on Linux
if [ "$OS" = "Linux" ]; then
  if ! ldd --version 2>&1 | grep -q 'GNU\|GLIBC'; then
    OS_TAG="unknown-linux-musl"
    TARGET="${ARCH_TAG}-${OS_TAG}"
  fi
fi

# Determine version
if [ -z "$VERSION" ]; then
  VERSION=$(curl -fsSL "https://api.github.com/repos/${REPO}/releases/latest" | grep '"tag_name"' | sed 's/.*"v\(.*\)".*/\1/')
fi

ARCHIVE="${PROJECT}-${VERSION}-${TARGET}.tar.gz"
URL="https://github.com/${REPO}/releases/download/v${VERSION}/${ARCHIVE}"
SHA_URL="https://github.com/${REPO}/releases/download/v${VERSION}/SHA256SUMS"

echo "Installing ${PROJECT} v${VERSION} for ${TARGET}..."

# Create temp directory
TMP_DIR=$(mktemp -d)
trap 'rm -rf "$TMP_DIR"' EXIT

# Download archive and checksums
echo "Downloading ${URL}..."
curl -fsSL -o "${TMP_DIR}/${ARCHIVE}" "$URL"
curl -fsSL -o "${TMP_DIR}/SHA256SUMS" "$SHA_URL"

# Verify checksum
echo "Verifying checksum..."
cd "$TMP_DIR"
EXPECTED=$(grep "$ARCHIVE" SHA256SUMS | awk '{print $1}')
if command -v sha256sum > /dev/null 2>&1; then
  ACTUAL=$(sha256sum "$ARCHIVE" | awk '{print $1}')
else
  ACTUAL=$(shasum -a 256 "$ARCHIVE" | awk '{print $1}')
fi

if [ "$EXPECTED" != "$ACTUAL" ]; then
  echo "Error: Checksum verification failed!"
  echo "Expected: $EXPECTED"
  echo "Got:      $ACTUAL"
  rm -f "$ARCHIVE"
  exit 1
fi
echo "Checksum verified."

# Extract and install
tar -xzf "$ARCHIVE"
mkdir -p "$INSTALL_DIR"
cp "$BINARY" "$INSTALL_DIR/$BINARY"
chmod +x "$INSTALL_DIR/$BINARY"

echo "Installed ${BINARY} to ${INSTALL_DIR}/${BINARY}"

# Check if install dir is in PATH
case ":$PATH:" in
  *":${INSTALL_DIR}:"*) ;;
  *) echo "\nNote: ${INSTALL_DIR} is not in your PATH."
     echo "Add it with: export PATH=\"${INSTALL_DIR}:\$PATH\""
     ;;
esac
