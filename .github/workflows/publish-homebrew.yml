name: Publish Homebrew Formula

on:
  workflow_call:
    inputs:
      project-name:
        description: Name of the project
        required: true
        type: string
      version:
        description: Release version (without v prefix)
        required: true
        type: string
      targets:
        description: JSON array of target triples
        required: true
        type: string
      binary-name:
        description: Name of the binary (defaults to project-name)
        required: false
        type: string
        default: ""
      description:
        description: Project description for the formula
        required: false
        type: string
        default: ""
      homepage:
        description: Project homepage URL
        required: false
        type: string
        default: ""
      license:
        description: Project license identifier
        required: false
        type: string
        default: "MIT"
      tap-repo:
        description: Homebrew tap repository (owner/repo)
        required: false
        type: string
        default: "keathmilligan/homebrew-tap"
    secrets:
      HOMEBREW_TAP_TOKEN:
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Download SHA256SUMS
        run: |
          curl -fsSL -o SHA256SUMS \
            "https://github.com/${{ github.repository }}/releases/download/v${{ inputs.version }}/SHA256SUMS"

      - name: Extract checksums
        id: checksums
        run: |
          PROJECT="${{ inputs.project-name }}"
          VERSION="${{ inputs.version }}"

          get_sha() {
            grep "${PROJECT}-${VERSION}-${1}.tar.gz" SHA256SUMS | awk '{print $1}' || echo ""
          }

          echo "macos-arm64=$(get_sha aarch64-apple-darwin)" >> "$GITHUB_OUTPUT"
          echo "macos-x86_64=$(get_sha x86_64-apple-darwin)" >> "$GITHUB_OUTPUT"
          echo "linux-arm64=$(get_sha aarch64-unknown-linux-gnu)" >> "$GITHUB_OUTPUT"
          echo "linux-x86_64=$(get_sha x86_64-unknown-linux-gnu)" >> "$GITHUB_OUTPUT"

      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.tap-repo }}
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap

      - name: Generate formula
        run: |
          BINARY="${{ inputs.binary-name || inputs.project-name }}"
          # Convert project name to Ruby class name (PascalCase)
          CLASS_NAME=$(echo "${{ inputs.project-name }}" | sed -r 's/(^|[-_])([a-z])/\U\2/g')

          cat > "tap/Formula/${{ inputs.project-name }}.rb" << 'FORMULA_EOF'
          # typed: false
          # frozen_string_literal: true

          class ${CLASS_NAME} < Formula
            desc "${{ inputs.description }}"
            homepage "${{ inputs.homepage }}"
            version "${{ inputs.version }}"
            license "${{ inputs.license }}"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/${{ github.repository }}/releases/download/v${{ inputs.version }}/${{ inputs.project-name }}-${{ inputs.version }}-aarch64-apple-darwin.tar.gz"
                sha256 "${{ steps.checksums.outputs.macos-arm64 }}"
              else
                url "https://github.com/${{ github.repository }}/releases/download/v${{ inputs.version }}/${{ inputs.project-name }}-${{ inputs.version }}-x86_64-apple-darwin.tar.gz"
                sha256 "${{ steps.checksums.outputs.macos-x86_64 }}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/${{ github.repository }}/releases/download/v${{ inputs.version }}/${{ inputs.project-name }}-${{ inputs.version }}-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${{ steps.checksums.outputs.linux-arm64 }}"
              else
                url "https://github.com/${{ github.repository }}/releases/download/v${{ inputs.version }}/${{ inputs.project-name }}-${{ inputs.version }}-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${{ steps.checksums.outputs.linux-x86_64 }}"
              end
            end

            def install
              bin.install "${BINARY}"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/${BINARY} --version")
            end
          end
          FORMULA_EOF

      - name: Validate formula
        run: |
          brew audit --new-formula "tap/Formula/${{ inputs.project-name }}.rb" || true
          brew style "tap/Formula/${{ inputs.project-name }}.rb" || true

      - name: Commit and push
        working-directory: tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "Formula/${{ inputs.project-name }}.rb"
          git commit -m "Update ${{ inputs.project-name }} to ${{ inputs.version }}"
          git push
